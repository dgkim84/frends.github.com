<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Domain module 소개 |  프론트앤드 개발자들의 모루! 프랜즈(frends)</title>
    <meta name="description" content="프론트앤드 개발자들이 모여서 노는 놀이터이자 작업공간입니다. 기본 바탕은 서로에게 공유하고 그만큼 얻어가자라는 &gt;    취지와 프로그래밍을 통해 창조를 취미로 하는 사람들이 모인 공간입니다.">
    <meta name="author" content="frends">
    <meta name="keywords" content="javascript,node.js,html5,css3,git,jQuery" />
    <meta name="generator" content="haroopress v0.8.4" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link href="/rss.xml" rel="alternate" title="프론트앤드 개발자들의 모루! 프랜즈(frends)" type="application/rss+xml">

    <!-- Le styles -->
    <link rel="canonical" href="http://frends.kr">

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/css/prettify.css" rel="stylesheet">
    <link href="/css/haroopress.css" rel="stylesheet">
    <link href="/css/archives.css" rel="stylesheet">

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <!--<link rel="apple-touch-icon" href="assets/ico/bootstrap-apple-57x57.png">-->
    <link rel="apple-touch-icon" sizes="72x72" href="/favicon-64.png">
    <!--<link rel="apple-touch-icon" sizes="114x114" href="assets/ico/bootstrap-apple-114x114.png">-->

    <!-- Le javascript -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/prettify.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/jquery.jsonp.js"></script>
    <script src="/js/mustache.js"></script>
    <script src="/js/apps/github.js"></script>
    <script src="/js/apps/twitter.js"></script>
</head>

  <body data-spy="scroll" data-target=".subnav" data-offset="50">

        <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>

          <a class="pull-right" href="/rss.xml"><img src="/img/buttons/rss.png" /></a>
          
            <a class="pull-right" href="http://twitter.com/frends_kr" target="_blank"><img src="/img/buttons/twitter.png" /></a>
          

          <div class="nav-collapse">
            <ul class="nav">
              <li>
                <a href="/">Home</a>
              </li>
              <li>
                <a href="/archives">Archives</a>
              </li>
                
                    <li>
                        <a href="/projects/">Projects</a>
                    </li>
                
            </ul>
          </div>
        </div>
      </div>
    </div>


    <div class="container page-archive">
    <div class="row">
        <div class="span3">
            <div id="author" class="well">
                <div>
                    <h3>About Author</h3>
                    <ul class="thumbnails">
                        <li>
                            <a class="thumbnail">
                                <img src="http://www.gravatar.com/avatar/2742e7d0ee5074de9ead238db2462f4d?r=pg&amp;s=128.jpg&amp;d=identicon" />
                            </a>
                        </li>
                    </ul>
                    <p>
                        <strong>nanhapark</strong><br/>
                        blog: <a href="undefined" target="_blank">http://nodeqa.com</a><br/>
                        twitter: <a href="http://twitter.com/undefined" target="_blank">@nanhapark</a><br/>
                        github: <a href="https://github.com/undefined" target="_blank">nanha</a>
                    </p>
                    <p>
                        <a href="https://twitter.com/nanhapark" class="twitter-follow-button" data-show-count="true">Follow @nanhapark</a>
                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                    </p>
                    <p>
                        <p>:) Javascript(Node.JS), python, bash, php
:) company: KTH , part: DevOps. <a href="http://about.me/nanha">http://about.me/nanha</a>
Seoul, Korea · <a href="http://nodeqa.com">http://nodeqa.com</a></p>

                    </p>
                </div>
                <div>
                    <h3>About this Article</h3>
                    <p>
                        <h5>Date Released:</h5>
                        <span>Monday, July 16 2012 12:13 AM</span>
                    </p>
                </div>
            </div>
                        <div class="well">
                <ul class="nav nav-list">
                    <li class="nav-header">Categories</li>
                    <li class=""><a href="/category"><i class="icon-home"></i> Home</a></li>
                    
                    <li><a href="/category/javascript"><i class="icon-book"></i> javascript</a></li>
                    
                    <li><a href="/category/javascript core"><i class="icon-book"></i> javascript core</a></li>
                    
                    <li><a href="/category/couchdb"><i class="icon-book"></i> couchdb</a></li>
                    
                    <li><a href="/category/node.js"><i class="icon-book"></i> node.js</a></li>
                    
                    <li><a href="/category/conference"><i class="icon-book"></i> conference</a></li>
                    
                    <li><a href="/category/frends"><i class="icon-book"></i> frends</a></li>
                    
                    <li><a href="/category/notice"><i class="icon-book"></i> notice</a></li>
                    
                    <li><a href="/category/google"><i class="icon-book"></i> google</a></li>
                    
                    <li><a href="/category/html5"><i class="icon-book"></i> html5</a></li>
                    
                    <li><a href="/category/jquery"><i class="icon-book"></i> jquery</a></li>
                    
                    <li><a href="/category/java"><i class="icon-book"></i> java</a></li>
                    
                    <li><a href="/category/news"><i class="icon-book"></i> news</a></li>
                    
                    <li><a href="/category/rhino"><i class="icon-book"></i> rhino</a></li>
                    
                    <li><a href="/category/css3"><i class="icon-book"></i> css3</a></li>
                    
                    <li><a href="/category/tech"><i class="icon-book"></i> tech</a></li>
                    
                </ul>
            </div>

            
<div class="well">
    <ul class="nav nav-list">
        <li class="nav-header">Recent Articles</li>
    
        <li>
            <a href="/post/domain-api" target="_blank">Domain module 소개
            <span class="label">nanhapark</span></a>
        </li>
    
        <li>
            <a href="/post/nodejs-beatiful-logging-winston" target="_blank">beautiful logging winston (nodejs 프로그래밍에 필수적인 프로그래밍 과정 logging)
            <span class="label">nanhapark</span></a>
        </li>
    
        <li>
            <a href="/post/go-together-nodejs" target="_blank">Go together nodejs
            <span class="label">nanhapark</span></a>
        </li>
    
        <li>
            <a href="/post/node-dot-j-s-v0-dot-6-gwa-v0-dot-8-yi-api-byeongyeongiryeog" target="_blank">Node.js v0.8 발표요약
            <span class="label">Rhio Kim</span></a>
        </li>
    
        <li>
            <a href="/post/frends-6ca-moim-hugi" target="_blank">FRENDS 6차 모임 후기
            <span class="label">frends</span></a>
        </li>
    
    </ul>
</div>

        </div>
        <div class="span9">
            <div class="row">
                <div class="span9">
                    <div class="well bg">
                        
                        <div class="page-header">
                            <h1>Domain module 소개</h1>
                        </div>

                        

                        <div class="pull-right">
                            <div class="fb-like" data-send="false" data-layout="button_count" data-width="100" data-show-faces="false" data-font="arial"></div>
                            <div id="fb-root"></div>
                            <script>(function(d, s, id) {
                              var js, fjs = d.getElementsByTagName(s)[0];
                              if (d.getElementById(id)) return;
                              js = d.createElement(s); js.id = id;
                              js.src = "//connect.facebook.net/ko_KR/all.js#xfbml=1&appId=246177242115486";
                              fjs.parentNode.insertBefore(js, fjs);
                            }(document, 'script', 'facebook-jssdk'));</script>
                        </div>

                                            
                        <div class="pull-right">
                            <!-- Place this tag where you want the +1 button to render -->
                            <g:plusone href="/post/domain-api" size="medium"></g:plusone>

                            <!-- Place this render call where appropriate -->
                            <script type="text/javascript">
                              (function() {
                                var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
                                po.src = 'https://apis.google.com/js/plusone.js';
                                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
                              })();
                            </script>
                        </div>
                    

                                            
                        <div class="pull-right">
                            <a href="https://twitter.com/share" class="twitter-share-button" data-lang="en" data-text="Domain module 소개 -" data-url="http://frends.kr/post/domain-api" data-via="nanhapark">Tweet</a>
                            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
                        </div>
                    

                        <div class="markdown">
                            <blockquote>
<p>Domains provide a way to handle multiple different IO operations as a single group. If any of the event emitters or callbacks registered to a domain emit an error event, or throw an error, then the domain object will be notified, rather than losing the context of the error in the process.on('uncaughtException') handler, or causing the program to exit with an error code.</p>
</blockquote>
<p>node <code>v0.8</code> 새로운 기능 <a href="http://nodejs.org/api/domain.html">domain api</a>, 뭐라 설명하기가 굉장히 애매한 API입니다. 그냥 에러처리기라고 하기도 그렇고... 위 정의가 굉장히 멋있는데, 실무에서 사용한 결과 제 입장에서는 <code>try ~ catch</code> 의 또다른 형태라고 정의하였습니다. 아래 소스설명 보시고 나름 이해하시고 정의 내리시면 됩니다. 그리고, 저와 다른 정의를 내린 분은 의견 공유 부탁드려요.</p>

<h1>배경</h1>

<p>nodejs의 callback에서 발생하는 <code>throw</code>를 전체 프로세스를 묶은 <code>try</code>로 에러를 제어 할 수 없습니다. 예를 들어봅시다.</p>

<ul>
<li><p>다른 언어에서 <code>try~catch</code>는 여러개의 모듈사용 흐름을 하나의 프로세스 흐름으로 생각하고 에러처리를 도와줍니다. 보통 모듈에서 throw를 반환하고 이를 사용하는 로직레벨에서는 <code>try~catch</code>로 제어하여 깔끔한 구문을 만들 수 있죠. 이것이 nodejs에서 된다면 굉장히 편할 것입니다.
아래 소스는 <code>fs.mkdir</code>를 <code>try~catch</code>로 묶어 보고 싶은 심정의 코드입니다.</p>

<pre><code>try {
  fs.mkdir(dirname, function(err, data) {
    if (err) {
      throw err;
    }
    cb(null, data);
  });
} catch (e) {
  console.log(e);
}
</code></pre></li>
</ul>

<p>위의 예제는 catch 구문에서 callback으로부터 throw 에러가 잡히면 깔끔한데, 그렇게 처리되지 않습니다. @.@</p>

<ul>
<li><p>callback 안에서 try... 당연히 catch 잡히죠. 그러나, 쓸모가 없습니다. <code>try~catch</code>는 전체적인 흐름을 컨트롤 할 수 있어야 쓸모가 있다고 생각합니다.</p>

<pre><code>fs.mkdir(dirname, function(err, data) {
  try {
    if (err) {
      throw err;
    }
    cb(null, data);
  } catch (e) {
    console.log(e);
  }
});
</code></pre></li>
</ul>

<hr>

<p>자 이리하여 등장한 <a href="http://nodejs.org/api/domain.html">domain api</a> 이런 경우에 대해 조금이나마 <code>해결 혹은 아이디어</code>를 제공해줍니다. 돌이켜보면 처음에 try~catch 구문을 어떻게서든지 사용할라고 노력했으나, 지금은 <code>process.on('uncaughtException')</code>에 기대고 있네요.</p>

<h1>사용순서</h1>

<ul>
<li><p>domain 모듈 <code>require</code></p>

<pre><code>var domain = require('domain');
</code></pre></li>
<li><p>domain <code>객체의 생성</code></p>

<pre><code>var d = domain.create();
</code></pre></li>
<li><p>domain에서 체크할 함수 등록</p>

<pre><code>d.run(function() {});
var foo = d.bind(function() {});
</code></pre></li>
<li><p>domain과 에러 핸들링 선언</p>

<pre><code>d.on('error', function(err) {});
</code></pre></li>
</ul>

<p><a href="http://nodejs.org/api/domain.html">domain api</a> 에 기타 함수설명들이 있습니다.</p>

<h1>사용패턴</h1>

<p>보통 아래 3가지 경우로 요약할 수 있습니다. </p>

<ul>
<li><p>callback function에 <code>domain</code>을 연결하여 오류 처리</p>

<pre><code>var domain = require('domain').create();
domain.bind(function() {});
</code></pre></li>
<li><p>함수를 호출할 때 <code>domain</code>을 연결하여 오류 처리</p>

<pre><code>var domain = require('domain').create();
(domain.bind(foo))(function() {});
</code></pre></li>
<li><p>함수 정의시 <code>domain</code>을 연결하여 오류 처리</p>

<pre><code>var domain = require('domain').create();
var fooWrapDomain = domain.bind(foo);
fooWrapDomain(function() {});
</code></pre></li>
</ul>

<h1>crash 되지 않도록 하는 일반적인 소스</h1>

<h2>a.js</h2>

<pre><code>var foomodule = require('./foomodule');
//
// 모든 throw 를 처리
// 무조건 필수!!!!!!!!!!!!!!
//
process.on('uncaughtException', function(err) {
  console.log('uncaughtException ===');
  console.log(err);
});
//
// 모듈호출
// recursive/directory 전달하여 fs.mkdir에서 처리될 수 없도록 에러발생
//
foomodule.foo('recursive/directory', function() {
  console.log('result ===');
  console.log(arguments);
});
</code></pre>

<h2>foomodule.js</h2>

<pre><code>var fs = require('fs');

//
// @param String dirname
// @paran Function cb
//
function foo(dirname, cb) {
  fs.mkdir(dirname, function(err, data) {
    if (err) {
      // 에러발생
      throw err;
    }

    cb(null, data);
  });
}

module.exports = {
  foo: foo
};
</code></pre>

<h2>실행결과</h2>

<pre><code>uncaughtException ===
{ [Error: ENOENT, mkdir 'recursive/directory'] errno: 34, code: 'ENOENT', path: 'recursive/directory' }
</code></pre>

<p>이 경우의 단점은 <code>process.on('uncaughtException', function() {})</code>으로 모든 <code>에러</code>가 처리되기 때문에, 모듈을 호출시 <code>해당 컨텍스트안</code>에서 무엇을 처리할 <code>요구사항</code>이 생긴다면 멘붕이 다가올 수 있습니다.</p>

<h1>crash 되지 않도록 domain api를 사용하는 소스</h1>

<p>초점은 모듈 context 안에서 무언가를 처리하자는 목적입니다.</p>

<h2>a.js</h2>

<pre><code>var foomodule = require('./foomodule');
//
// 모든 throw 를 처리
// 사용안함.
//
process.on('xxxxx___uncaughtException', function(err) {
  console.log('uncaughtException ===');
  console.log(err);
});
//
// 모듈호출
// recursive/directory 전달하여 fs.mkdir에서 처리될 수 없도록 에러발생
//
foomodule.foo('recursive/directory', function() {
  console.log('result ===');
  console.log(arguments);
});
</code></pre>

<h2>foomodule.js</h2>

<pre><code>var fs = require('fs');

function foo(dirname, cb) {
  //
  // 도메인 require / 객체 생성
  //
  var domain = require('domain').create();

  //
  // domain에서 exception 체크
  //
  domain.on('error', function(err) {
    console.log('domain ===');
    console.log(err);

    // 현재 모듈의 context에서 처리
    cb('wow');
  });

  //
  // callback에 domain을 binding
  //
  fs.mkdir(dirname, domain.bind(function(err, data) {
    //
    // context안에서 에러나면 위 에러핸들러에서 처리됩니다.
    //
    if (err) {
      throw err;
    }

    cb(null, data);
  }));

  //
  // 밑에 혹은 위 callback 안에서 여러개의 함수조작을 하고, 안에 안에 안에 ... context에서 throw가 발생하더라도
  // 모두 domain error handling으로 컨트롤 할 수 있습니다.
  //
}

module.exports = {
  foo: foo
};
</code></pre>

<h2>실행결과</h2>

<pre><code>domain ===
{ [Error: ENOENT, mkdir 'recursive/directory']
  errno: 34,
  code: 'ENOENT',
  path: 'recursive/directory',
  domain_thrown: true,
  domain: { members: [], _events: { error: [Function] } } }
result ===
{ '0': 'wow' }
</code></pre>

<ul>
<li>domain과 에러 핸들링 선언한것이 동작했습니다.</li>
<li>uncaughtException 으로 처리되지 않아 <code>wow</code>라는 메세지를 <code>callback</code>으로 넘길 수 있었습니다.</li>
</ul>

<h1>crash 되지 않도록 domain api를 global 로 사용하는 소스</h1>

<h2>a.js</h2>

<pre><code>//
// try ~ catch 하나의 흐름으로 시도
//
global.domain = require('domain').create();

//
// domain에서 exception 체크
//
domain.on('error', function(err) {
  console.log('domain ===');
  console.log(err);
});

var foomodule = require('./foomodule');

//
// 모듈호출
// recursive/directory 전달하여 fs.mkdir에서 처리될 수 없도록 에러발생
//
foomodule.foo('recursive/directory', function() {
  console.log('result ===');
  console.log(arguments);
});
</code></pre>

<h2>foomodule.js</h2>

<pre><code>var fs = require('fs');

function foo(dirname, cb) {
  //
  // callback에 domain을 binding
  //
  fs.mkdir(dirname, domain.bind(function(err, data) {
    //
    // context안에서 에러나면 위 에러핸들러에서 처리됩니다.
    //
    if (err) {
      throw err;
    }

    cb(null, data);
  }));

  //
  // 한번더! callback에 domain을 binding
  //
  fs.mkdir(dirname, domain.bind(function(err, data) {
    //
    // context안에서 에러나면 위 에러핸들러에서 처리됩니다.
    //
    if (err) {
      throw err;
    }

    cb(null, data);
  }));
}

module.exports = {
  foo: foo
};
</code></pre>

<h2>실행결과</h2>

<pre><code>domain ===
{ [Error: ENOENT, mkdir 'recursive/directory']
  errno: 34,
  code: 'ENOENT',
  path: 'recursive/directory',
  domain_thrown: true,
  domain: { members: [], _events: { error: [Function] } } }
</code></pre>

<p>wow</p>

<h1>결론</h1>

<p>domain api에 대해서 설명을 드렸습니다. 저는 몇가지 아이디어가 떠오르네요. nodejs app을 crash 하지 않기 위해 <code>process.on('uncaughtException', function() {})</code>을 애용했는데, <code>domain api</code>도 적절히 포함시켜야 겠습니다. 질문은 <a href="http://nodeqa.com"><a href="http://nodeqa.com">http://nodeqa.com</a></a> 이곳으로 </p>

                        </div>
                        <hr />
                                            
                        <div class="row-fluid">
                            
                            <div class="pull-right">
                                <a href="/post/fluent-conference-29-may" class="btn btn-info">Fluent Conference 29 May <i class="icon-white icon-chevron-right"></i></a>
                            </div>
                            

                            
                            <div class="pull-left">
                                <a href="/post/couchdb-sijaghagi" class="btn btn-info"><i class="icon-white icon-chevron-left"></i> CouchDB 시작하기</a>
                            </div>
                            
                        </div>
                    

                        <div class="row-fluid">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'frendskr'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

                    </div>
                </div>
            </div>
            <div class="row">
            </div>
        </div>
    </div>
    <!--<div class="row">-->
        <!--<div class="offset3 span9">-->
            <!--<strong>tags</strong> :-->
            <!---->
        <!--</div>-->
    <!--</div>-->
</div><!-- /container -->


        <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="span12 ">
                    <div class="well">
                        <p class="pull-right"><a href="#">Back to top</a></p>
                            <strong>haroopress</strong> developed by <a href="http://twitter.com/rhiokim" target="_blank">@rhiokim</a>,<a href="http://twitter.com/haroopress" target="_blank">@haroopress</a> and source in <a href="https://github.com/rhiokim/haroopress" target="_blank">github</a><br/>
                            Designed and built with all the love in the world <a href="http://twitter.com/twitter" target="_blank">@twitter</a> by <a href="http://twitter.com/mdo" target="_blank">@mdo</a> and <a href="http://twitter.com/fat" target="_blank">@fat</a>.<br />
                            Code licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License v2.0</a>. Documentation licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        $('pre > code').parent().addClass('prettyprint linenums');
        prettyPrint();
    </script>
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-17041304-1']);
            _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>


    </body>
</html>
